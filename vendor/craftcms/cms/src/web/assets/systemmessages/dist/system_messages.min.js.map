{"version":3,"sources":["systemmessages/src/system_messages.js"],"names":["$","SystemMessages","Garnish","Base","extend","messages","$container","$messages","find","push","message","length","i","Message","this","$body","modal","container","key","$subject","init","attr","MessageSettingsModal","addListener","subject","Craft","escapeHtml","show","text","$subjectInput","val","body","$bodyInput","replace","html","Modal","data","language","$saveBtn","$cancelBtn","$spinner","loading","csrfTokenName","postActionRequest","loadContainer","$languageSelect","csrfTokenValue","proxy","response","textStatus","appendTo","$bod","setContainer","removeClass","setTimeout","trigger","switchLanguage","addClass","saveMessage","event","preventDefault","hide","primarySiteLanguage","updateHtmlFromModal","displayNotice","shake","success","cp","t","displayError","cancel","jQuery"],"mappings":"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","file":"system_messages.min.js","sourcesContent":["(function($) {\n    /** global: Craft */\n    /** global: Garnish */\n    var SystemMessages = Garnish.Base.extend(\n        {\n            messages: null,\n\n            init: function() {\n                this.messages = [];\n\n                var $container = $('#messages'),\n                    $messages = $container.find('.message');\n\n                for (var i = 0; i < $messages.length; i++) {\n                    var message = new Message($messages[i]);\n                    this.messages.push(message);\n                }\n            }\n        });\n\n\n    var Message = Garnish.Base.extend(\n        {\n            $container: null,\n            key: null,\n            $subject: null,\n            $body: null,\n            modal: null,\n\n            init: function(container) {\n                this.$container = $(container);\n                this.key = this.$container.attr('data-key');\n                this.$subject = this.$container.find('.subject:first');\n                this.$body = this.$container.find('.body:first');\n\n                this.addListener(this.$container, 'click', 'edit');\n            },\n\n            edit: function() {\n                if (!this.modal) {\n                    this.modal = new MessageSettingsModal(this);\n                }\n                else {\n                    this.modal.show();\n                }\n            },\n\n            updateHtmlFromModal: function() {\n                var subject = this.modal.$subjectInput.val(),\n                    body = Craft.escapeHtml(this.modal.$bodyInput.val()).replace(/\\n/g, '<br>');\n\n                this.$subject.text(subject);\n                this.$body.html(body);\n            }\n        });\n\n\n    var MessageSettingsModal = Garnish.Modal.extend(\n        {\n            message: null,\n\n            $languageSelect: null,\n            $subjectInput: null,\n            $bodyInput: null,\n            $saveBtn: null,\n            $cancelBtn: null,\n            $spinner: null,\n\n            loading: false,\n\n            init: function(message) {\n                this.message = message;\n\n                this.base(null, {\n                    resizable: true\n                });\n\n                this.loadContainer();\n            },\n\n            loadContainer: function(language) {\n                var data = {\n                    key: this.message.key,\n                    language: language\n                };\n\n                // If CSRF protection isn't enabled, these won't be defined.\n                if (typeof Craft.csrfTokenName !== 'undefined' && typeof Craft.csrfTokenValue !== 'undefined') {\n                    // Add the CSRF token\n                    data[Craft.csrfTokenName] = Craft.csrfTokenValue;\n                }\n\n                Craft.postActionRequest('system-messages/get-message-modal', data, $.proxy(function(response, textStatus) {\n                    if (textStatus === 'success') {\n                        if (!this.$container) {\n                            var $container = $('<form class=\"modal fitted message-settings\" accept-charset=\"UTF-8\">' + response.body + '</form>').appendTo(Garnish.$bod);\n                            this.setContainer($container);\n                            this.show();\n                        }\n                        else {\n                            this.$container.html(response.body);\n                        }\n\n                        this.$languageSelect = this.$container.find('.language:first > select');\n                        this.$subjectInput = this.$container.find('.message-subject:first');\n                        this.$bodyInput = this.$container.find('.message-body:first');\n                        this.$saveBtn = this.$container.find('.submit:first');\n                        this.$cancelBtn = this.$container.find('.cancel:first');\n                        this.$spinner = this.$container.find('.spinner:first');\n\n                        this.addListener(this.$languageSelect, 'change', 'switchLanguage');\n                        this.addListener(this.$container, 'submit', 'saveMessage');\n                        this.addListener(this.$cancelBtn, 'click', 'cancel');\n\n                        setTimeout($.proxy(function() {\n                            this.$subjectInput.trigger('focus');\n                        }, this), 100);\n                    }\n                }, this));\n            },\n\n            switchLanguage: function() {\n                this.loadContainer(this.$languageSelect.val());\n            },\n\n            saveMessage: function(event) {\n                event.preventDefault();\n\n                if (this.loading) {\n                    return;\n                }\n\n                var data = {\n                    key: this.message.key,\n                    language: (this.$languageSelect.length ? this.$languageSelect.val() : Craft.primarySiteLanguage),\n                    subject: this.$subjectInput.val(),\n                    body: this.$bodyInput.val()\n                };\n\n                this.$subjectInput.removeClass('error');\n                this.$bodyInput.removeClass('error');\n\n                if (!data.subject || !data.body) {\n                    if (!data.subject) {\n                        this.$subjectInput.addClass('error');\n                    }\n\n                    if (!data.body) {\n                        this.$bodyInput.addClass('error');\n                    }\n\n                    Garnish.shake(this.$container);\n                    return;\n                }\n\n                this.loading = true;\n                this.$saveBtn.addClass('active');\n                this.$spinner.show();\n\n                Craft.postActionRequest('system-messages/save-message', data, $.proxy(function(response, textStatus) {\n                    this.$saveBtn.removeClass('active');\n                    this.$spinner.hide();\n                    this.loading = false;\n\n                    if (textStatus === 'success') {\n                        if (response.success) {\n                            // Only update the page if we're editing the current language's message\n                            if (data.language === Craft.primarySiteLanguage) {\n                                this.message.updateHtmlFromModal();\n                            }\n\n                            this.hide();\n                            Craft.cp.displayNotice(Craft.t('app', 'Message saved.'));\n                        }\n                        else {\n                            Craft.cp.displayError();\n                        }\n                    }\n                }, this));\n            },\n\n            cancel: function() {\n                this.hide();\n\n                if (this.message) {\n                    this.message.modal = null;\n                }\n            }\n        });\n\n\n    new SystemMessages();\n})(jQuery);\n"]}