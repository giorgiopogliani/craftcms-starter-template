{"version":3,"sources":["pluginstoreoauth/src/PluginStoreOauthCallback.js"],"names":["$","Craft","PluginStoreOauthCallback","Garnish","Base","extend","$graphic","errorDetails","data","settings","$status","setTimeout","proxy","this","error","location","redirectUrl","message","html","errorMsg","window","fragmentString","postActionRequest","showError","hash","substr","fragments","parseFragmentString","response","textStatus","jqXHR","updateStatus","getCpUrl","t","addClass","showFatalError","$buttonContainer","escapeHtml","statusText","responseText","encodeURIComponent","getActionUrl","statusHtml","msg","appendTo","$cancelBtn","class","href","text","$retryBtn","jQuery"],"mappings":"CAAA,SAACA,GACGC,MAAMC,yBAA2BC,QAAQC,KAAKC,OAEtCC,CACOA,SAFX,KAGIC,QAAc,KACRA,aAJV,KAKYC,KALZ,KAOUC,SAASA,KAGNH,KAAAA,SAAaG,GAIJ,GAHTC,KAAUV,YAAfS,GAEUA,KAAAA,SAAgBT,EAAA,YACtBW,KAAaC,QAAMZ,EAAA,WAATa,KAAVJ,SAAAK,MAOaF,CACFG,IAAAA,EAAgBN,KAAAA,SAASO,QAAhCH,KAAAJ,SAAAQ,QAAAJ,KAAAJ,SAAAK,MACMD,KAFVH,QAAAQ,KAAAC,GArBZR,WAAAX,EAAAY,OAAA,WA2BuBQ,OAAAL,SAAWF,KAAAJ,SAAAO,cACtBK,MAAiBD,UAXbT,WAAAX,EAAAY,OAAA,WACWC,KAAKJ,sBACPS,MAAKC,MAedG,kBAAmB,WACf,IAAKC,EAAmBT,OAAxBC,SAAAS,KAAAC,OAAA,GACGC,EAAA1B,EAAA2B,oBAAAN,GAEHpB,MAAKK,kBAAkB,0BAEvBoB,EAAA1B,EAAAY,OAAA,SAAAgB,EAAAC,EAAAC,GACmB,WAAPD,EACED,EAAKnB,MACJM,KAAPQ,UAAuBd,EAASO,QAEzBD,KAAPgB,aAAwBC,MAAS/B,MAAAgC,EAAA,MAAjC,cAAA,QACHpB,KAAAP,SAAA4B,SAAA,WAGNvB,WAAAX,EAAAY,OAAA,gBACH,IAAAC,KAAAJ,SAAAO,YACHI,OAAAL,SAAAF,KAAAJ,SAAAO,YAnDbI,OAAAL,SAAAd,MAAA+B,SAAA,kBAwD+BnB,MAAvB,MAxDRA,KAAAsB,eAAAL,KA+EqBZ,QAIRZ,eAAL,SAAAwB,GACKC,KAAAA,SAAaG,SAAc,SAE5BE,IAAAA,EAEU,MAAAnC,MAASgC,EAAA,MAAA,+BAAT,4DAAShC,MAAAgC,EAAA,MAAA,WAAA,aAAAhC,MAAAoC,WAAAP,EAAAQ,YAAT,+BAGJrC,MAAAgC,EAAA,MAAA,aAAA,aAAAhC,MAAAoC,WAAAP,EAAAS,cAHI,iFAMQC,mBAAA,wBAEVvC,SAAMwC,mBACR,0GAEbX,EAAAQ,WAFa,iBAlGtBR,EAAAS,cAwEgB,KACAtC,MAAMgC,EAAE,MAAO,iBACf,OAEJpB,KAAKkB,aAAaW,IAGtBX,aAAc,SAASb,GACnBL,KAAKH,QAAQQ,KAAKA,IAGtBK,UAAW,SAASoB,GAChB9B,KAAKP,SAAS4B,SAAS,SACvBrB,KAAKkB,aAAa,MAAQY,EAAM,QAEhC,IAAIP,EAAmBpC,EAAE,gCAAgC4C,SAAS/B,KAAKH,SAEvEmC,WAAa7C,EAAE,OAAQ,CACnB8C,MAAS,UACTC,KAAQ9C,MAAM+B,SAAS,gBACvBgB,KAAM,WACPJ,SAASR,GAEZa,UAAYjD,EAAE,OAAQ,CAClB8C,MAAS,UACTC,KAAQ9C,MAAMwC,aAAa,wBAC3BO,KAAM,cACPJ,SAASR,MApG5B,CAuGGc","file":"PluginStoreOauthCallback.min.js","sourcesContent":["(function($) {\n    Craft.PluginStoreOauthCallback = Garnish.Base.extend(\n        {\n            $graphic: null,\n            $status: null,\n            errorDetails: null,\n            data: null,\n            settings: null,\n\n            init: function(settings) {\n                this.setSettings(settings);\n                \n                this.$graphic = $('#graphic');\n                this.$status = $('#status');\n\n                if (!this.settings.error) {\n                    setTimeout($.proxy(function() {\n                        this.postActionRequest();\n                    }, this), 500);\n                }  else {\n                    var errorMsg = this.settings.message ? this.settings.message : this.settings.error;\n                    this.$status.html(errorMsg);\n\n                    setTimeout($.proxy(function() {\n                        window.location = this.settings.redirectUrl;\n                    }, this), 1000)\n                }\n            },\n\n            postActionRequest: function() {\n                var fragmentString = window.location.hash.substr(1);\n                var fragments = $.parseFragmentString(fragmentString);\n\n                Craft.postActionRequest('plugin-store/save-token', fragments, $.proxy(function(response, textStatus, jqXHR)\n                {\n                    if (textStatus == 'success') {\n                        if(response.error) {\n                            this.showError(response.error);\n                        } else {\n                            this.updateStatus('<p>' + Craft.t('app', 'Connected!') + '</p>');\n                            this.$graphic.addClass('success');\n\n                            // Redirect to the Dashboard in half a second\n                            setTimeout($.proxy(function() {\n                                if(typeof(this.settings.redirectUrl) != 'undefined') {\n                                    window.location = this.settings.redirectUrl;\n                                } else {\n                                    window.location = Craft.getCpUrl('plugin-store');\n                                }\n                            }, this), 500);\n                        }\n                    } else {\n                        this.showFatalError(jqXHR);\n                    }\n                }, this));\n            },\n\n            showFatalError: function(jqXHR) {\n                this.$graphic.addClass('error');\n                var statusHtml =\n                    '<p>' + Craft.t('app', 'A fatal error has occurred:') + '</p>' +\n                    '<div id=\"error\" class=\"code\">' +\n                    '<p><strong class=\"code\">' + Craft.t('app', 'Status:') + '</strong> ' + Craft.escapeHtml(jqXHR.statusText) + '</p>' +\n                    '<p><strong class=\"code\">' + Craft.t('app', 'Response:') + '</strong> ' + Craft.escapeHtml(jqXHR.responseText) + '</p>' +\n                    '</div>' +\n                    '<a class=\"btn submit big\" href=\"mailto:support@craftcms.com' +\n                    '?subject=' + encodeURIComponent('Craft update failure') +\n                    '&body=' + encodeURIComponent(\n                        'Describe what happened here.\\n\\n' +\n                        '-----------------------------------------------------------\\n\\n' +\n                        'Status: ' + jqXHR.statusText + '\\n\\n' +\n                        'Response: ' + jqXHR.responseText\n                    ) +\n                    '\">' +\n                    Craft.t('app', 'Send for help') +\n                    '</a>';\n\n                this.updateStatus(statusHtml);\n            },\n\n            updateStatus: function(html) {\n                this.$status.html(html);\n            },\n\n            showError: function(msg) {\n                this.$graphic.addClass('error');\n                this.updateStatus('<p>' + msg + '</p>');\n\n                var $buttonContainer = $('<div id=\"junction-buttons\"/>').appendTo(this.$status);\n\n                $cancelBtn = $('<a/>', {\n                    'class': 'btn big',\n                    'href': Craft.getCpUrl('plugin-store'),\n                    text: \"Cancel\",\n                }).appendTo($buttonContainer);\n\n                $retryBtn = $('<a/>', {\n                    'class': 'btn big',\n                    'href': Craft.getActionUrl('plugin-store/connect'),\n                    text: \"Try again\",\n                }).appendTo($buttonContainer);\n            }\n        });\n})(jQuery);"]}