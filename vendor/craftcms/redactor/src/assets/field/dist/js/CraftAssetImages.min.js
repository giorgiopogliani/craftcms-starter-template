var plugin=$.extend({},Craft.Redactor.PluginBase,{title:"image",apiTarget:"plugin.craftAssetImages.showModal",icon:'<i class="re-icon-image"></i>',transforms:[],volumes:null,allowAllUploaders:!1,defaultTransform:"",modalState:{selectedTransform:null},showModal:function(){if(this.app.selection.isCollapsed()?(this.app.selection.save(),this.app.selectionMarkers=!1):(this.app.selection.saveMarkers(),this.app.selectionMarkers=!0),void 0===this.assetSelectionModal){const e={siteId:this.elementSiteId,kind:"image"};this.allowAllUploaders&&(e.uploaderId=null),this.assetSelectionModal=Craft.createElementSelectorModal("craft\\elements\\Asset",{storageKey:"RedactorInput.ChooseImage",multiSelect:!0,sources:this.volumes,criteria:e,onSelect:function(e,s){if(e.length){this.app.selectionMarkers?this.app.selection.restoreMarkers():this.app.selection.restore(),this.app.selectionMarkers=!1;const t={},r=e.length>1,a=function(e,r){const n=e.pop(),o=this._isTransformUrl(n.url);if(o||0==this.defaultTransform.length)t["asset"+n.id]={url:this._buildAssetUrl(n.id,n.url,o?s:this.defaultTransform),id:n.id},e.length?a(e,r):r();else{this._getTransformUrl(n.id,this.defaultTransform,function(s){t["asset"+n.id]={url:this._buildAssetUrl(n.id,s,this.defaultTransform),id:n.id},e.length?a(e,r):r()}.bind(this))}}.bind(this);a(e,function(){this.app.api("module.image.insert",t),r||(this.modalState.selectedTransform=this.defaultTransform,this.app.api("module.image.open"))}.bind(this))}}.bind(this),transforms:this.transforms,closeOtherModals:!1})}else this.assetSelectionModal.show()},setTransforms:function(e){this.transforms=e},setDefaultTransform:function(e){this.defaultTransform=e},setVolumes:function(e){this.volumes=e},_buildAssetUrl:(e,s,t)=>s+"#asset:"+e+":"+(t?"transform:"+t:"url"),_removeTransformFromUrl:e=>e.replace(/(.*)(_[a-z0-9+].*\/)(.*)/,"$1$3"),_isTransformUrl:e=>/(.*)(_[a-z0-9+].*\/)(.*)/.test(e),_getTransformUrl:function(e,s,t){var r={assetId:e,handle:s};Craft.postActionRequest("assets/generate-transform",r,(function(e,s){"success"===s&&(e.url?t(e.url):alert("There was an error generating the transform URL."))}))},_getAssetUrlComponents:e=>{const s=e.match(/(.*)#asset:(\d+):(url|transform):?([a-zA-Z][a-zA-Z0-9_]*)?/);return s?{url:s[1],assetId:s[2],transform:"url"!==s[3]?s[4]:null}:null},onmodal:{imageedit:{open:function(e,s){const t=this._getAssetUrlComponents(this.app.module.image.$image.$element.nodes[0].src);if(!t)return;let{transform:r}=t;r&&r.length?this.modalState.selectedTransform=r:r=this.defaultTransform;const a=[{handle:"",name:"No transform"}].concat(this.transforms),n=$('<select id="modal-image-transform"></select>').on("change",function(e){this.modalState.selectedTransform=$(e.currentTarget).val()}.bind(this));for(optionIndex in a){let e=a[optionIndex],s=r&&e.handle==r;n.append('<option value="'+e.handle+'"'+(s?' selected="selected"':"")+">"+e.name+"</option>")}const o=$('<div class="form-item form-item-transform"><label for="modal-image-transform">Transform</label></div>').append(n);$(s.nodes[0]).append(o)}}},onimage:{changed:function(e){const s=$(e.$element.nodes[0]),t=this._getAssetUrlComponents(s.attr("src")),r=this.modalState.selectedTransform;if(!t)return;const{transform:a,assetId:n,url:o}=t;if(a!=r)if(s.fadeTo(100,.2),r.length)this._getTransformUrl(n,r,function(e){s.prop("src",this._buildAssetUrl(n,e,r)),s.stop().fadeTo(0,1)}.bind(this));else{new RegExp("(.*)(_"+a+".*/)(.*)");s.prop("src",this._buildAssetUrl(n,this._removeTransformFromUrl(o),r)),s.stop().fadeTo(0,1)}}}});Redactor.add("plugin","craftAssetImages",plugin);
//# sourceMappingURL=CraftAssetImages.min.js.map
