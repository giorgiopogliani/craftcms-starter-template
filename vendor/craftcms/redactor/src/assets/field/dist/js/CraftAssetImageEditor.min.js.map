{"version":3,"sources":["CraftAssetImageEditor.js"],"names":["plugin","$","extend","Craft","Redactor","PluginBase","assetId","start","open","this","settings","allowSavingAsNew","onSave","reloadImage","bind","allowDegreeFractions","isImagick","AssetImageEditor","$images","app","editor","getElement","find","refreshNodeSource","node","matches","src","match","params","handle","postActionRequest","data","url","Date","getTime","nodes","storage","observeImages","add"],"mappings":"AAAA,IAAIA,OAASC,EAAEC,OAAO,GAAIC,MAAMC,SAASC,WAAY,CAEjDC,QAAS,KAETC,MAAO,aAGPC,KAAM,SAASF,GACXG,KAAKH,QAAUA,EAEf,IAAII,EAAW,CACXC,kBAAkB,EAClBC,OAAQH,KAAKI,YAAYC,KAAKL,MAC9BM,qBAAsBZ,MAAMa,WAGhC,IAAIb,MAAMc,iBAAiBX,EAASI,IAGxCG,YAAa,WACT,IACIK,EADUT,KAAKU,IAAIC,OAAOC,aACRC,KAAK,gBAEvBC,EAAoB,SAASC,GAC7B,IAAIC,EAAUD,EAAKE,IAAIC,MAAM,uCAG7B,GAAIF,GAAWA,EAAQ,IAAMhB,KAAKH,QAE9B,GAAKmB,EAAQ,GAEN,CACH,IAAIG,EAAS,CACTtB,QAASmB,EAAQ,GACjBI,OAAQJ,EAAQ,IAEpBtB,MAAM2B,kBAAkB,4BAA6BF,GAAQ,SAASG,GAClEP,EAAKE,IAAMK,EAAKC,IAAM,KAAO,IAAIC,MAAOC,UAAa,UAAYT,EAAQ,GAAK,cAAgBA,EAAQ,WAP1GD,EAAKE,IAAMD,EAAQ,GAAK,KAAO,IAAIQ,MAAOC,UAAa,UAAYT,EAAQ,IAWrFX,KAAKL,MAEP,IAAK,IAAIe,KAAQN,EAAQiB,MAErBZ,EADAC,EAAON,EAAQiB,MAAMX,IAIzBf,KAAKU,IAAIiB,QAAQC,mBAOtBjC,SADIkC,IAAI,SAAU,wBAAyBtC","file":"CraftAssetImageEditor.min.js","sourcesContent":["var plugin = $.extend({}, Craft.Redactor.PluginBase, {\n\n    assetId: null,\n\n    start: function() {\n    },\n\n    open: function(assetId) {\n        this.assetId = assetId;\n\n        var settings = {\n            allowSavingAsNew: false,\n            onSave: this.reloadImage.bind(this),\n            allowDegreeFractions: Craft.isImagick\n        };\n\n        new Craft.AssetImageEditor(assetId, settings);\n    },\n\n    reloadImage: function() {\n        var $editor = this.app.editor.getElement();\n        var $images = $editor.find('[data-image]');\n\n        var refreshNodeSource = function(node) {\n            var matches = node.src.match(/(.*)#asset:(\\d+)(:transform:(.*))?/i);\n\n            // Find all instances of THIS asset.\n            if (matches && matches[2] == this.assetId) {\n                // Not a transform\n                if (!matches[4]) {\n                    node.src = matches[1] + '?' + (new Date().getTime()) + '#asset:' + matches[2];\n                } else {\n                    var params = {\n                        assetId: matches[2],\n                        handle: matches[4]\n                    };\n                    Craft.postActionRequest('assets/generate-transform', params, function(data) {\n                        node.src = data.url + '?' + (new Date().getTime()) + '#asset:' + matches[2] + ':transform:' + matches[4];\n                    });\n                }\n            }\n        }.bind(this);\n\n        for (var node in $images.nodes) {\n            node = $images.nodes[node];\n            refreshNodeSource(node);\n        }\n\n        this.app.storage.observeImages();\n\n    }\n});\n\n(function($R) {\n    $R.add('plugin', 'craftAssetImageEditor', plugin);\n})(Redactor);"]}