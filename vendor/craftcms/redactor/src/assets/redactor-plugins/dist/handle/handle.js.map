{"version":3,"sources":["handle/handle.js"],"names":["$R","add","init","app","this","opts","$doc","$body","editor","marker","keycodes","container","selection","handleTrigger","handleStart","handleStr","handleLen","start","handle","getElement","on","_handle","bind","stop","off","dom","remove","e","key","which","ctrl","ctrlKey","metaKey","BACKSPACE","_isShown","_hide","DELETE","ESC","SHIFT","indexOf","re","RegExp","getTextBeforeCaret","test","replace","_load","ajax","post","url","data","success","_parse","json","JSON","parse","_build","_buildData","$list","length","append","_update","_show","html","$item","item","attr","_replace","offset","pos","getPosition","css","top","height","scrollTop","left","hasClass","addClass","show","hidable","type","ENTER","SPACE","removeClass","hide","_reset","preventDefault","target","replacement","insert","$marker","current","previousSibling","currentText","textContent","before","restoreMarkers","Redactor"],"mappings":"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","file":"handle.js","sourcesContent":["(function($R)\n{\n    $R.add('plugin', 'handle', {\n        init: function(app)\n        {\n            this.app = app;\n            this.opts = app.opts;\n            this.$doc = app.$doc;\n            this.$body = app.$body;\n            this.editor = app.editor;\n            this.marker = app.marker;\n            this.keycodes = app.keycodes;\n            this.container = app.container;\n            this.selection = app.selection;\n\n            // local\n            this.handleTrigger = (typeof this.opts.handleTrigger !== 'undefined') ? this.opts.handleTrigger : '@';\n            this.handleStart = (typeof this.opts.handleStart !== 'undefined') ? this.opts.handleStart : 0;\n            this.handleStr = '';\n            this.handleLen = this.handleStart;\n        },\n        // public\n        start: function()\n        {\n            if (!this.opts.handle) return;\n\n            var $editor = this.editor.getElement();\n\t\t\t$editor.on('keyup.redactor-plugin-handle', this._handle.bind(this));\n\t\t},\n\t\tstop: function()\n\t\t{\n            var $editor = this.editor.getElement();\n\n\t\t\t$editor.off('.redactor-plugin-handle');\n            this.$doc.off('.redactor-plugin-handle');\n\n            var $list = $R.dom('#redactor-handle-list');\n            $list.remove();\n\t\t},\n\n\t\t// private\n\t\t_handle: function(e)\n\t\t{\n    \t\tvar key = e.which;\n\t\t\tvar ctrl = e.ctrlKey || e.metaKey;\n\t\t\tvar arrows = [37, 38, 39, 40];\n\n            if (key === this.keycodes.BACKSPACE)\n            {\n                if (this._isShown() && (this.handleLen > this.handleStart))\n                {\n                    this.handleLen = this.handleLen - 2;\n                    if (this.handleLen <= this.handleStart)\n                    {\n                        this._hide();\n                    }\n                }\n                else\n                {\n                    return;\n                }\n            }\n\n\t\t\tif (key === this.keycodes.DELETE\n\t\t\t    || key === this.keycodes.ESC\n\t\t\t    || key === this.keycodes.SHIFT\n\t\t\t    || ctrl\n\t\t\t    || (arrows.indexOf(key) !== -1)\n\t\t\t)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n            var re = new RegExp('^' + this.handleTrigger);\n            this.handleStr = this.selection.getTextBeforeCaret(this.handleLen + 1);\n\n            // detect\n            if (re.test(this.handleStr))\n            {\n                this.handleStr = this.handleStr.replace(this.handleTrigger, '');\n                this.handleLen++;\n\n                this._load();\n            }\n\t\t},\n\t\t_load: function()\n\t\t{\n    \t\t$R.ajax.post({\n        \t\turl: this.opts.handle,\n        \t\tdata: 'handle=' + this.handleStr,\n        \t\tsuccess: this._parse.bind(this)\n    \t\t});\n\t\t},\n\t\t_parse: function(json)\n\t\t{\n    \t\tif (json === '') return;\n\n            var data = (typeof json === 'object') ? json : JSON.parse(json);\n\n            this._build();\n            this._buildData(data);\n\t\t},\n\t\t_build: function()\n\t\t{\n            this.$list = $R.dom('#redactor-handle-list');\n            if (this.$list.length === 0)\n            {\n                this.$list = $R.dom('<div id=\"redactor-handle-list\">');\n                this.$body.append(this.$list);\n            }\n        },\n        _buildData: function(data)\n        {\n            this.data = data;\n\n            this._update();\n            this._show();\n        },\n        _update: function()\n        {\n            this.$list.html('');\n\n            for (var key in this.data)\n            {\n                var $item = $R.dom('<a href=\"#\">');\n                $item.html(this.data[key].item);\n                $item.attr('data-key', key);\n                $item.on('click', this._replace.bind(this));\n\n                this.$list.append($item);\n            }\n\n            // position\n    \t\tvar $container = this.container.getElement();\n            var containerOffset = $container.offset();\n            var pos = this.selection.getPosition();\n\n            this.$list.css({\n                top: (pos.top + pos.height + this.$doc.scrollTop()) + 'px',\n                left: pos.left + 'px'\n            });\n        },\n        _isShown: function()\n        {\n            return (this.$list && this.$list.hasClass('open'));\n        },\n        _show: function()\n        {\n            this.$list.addClass('open');\n            this.$list.show();\n\n            this.$doc.off('.redactor-plugin-handle');\n            this.$doc.on('click.redactor-plugin-handle keydown.redactor-plugin-handle', this._hide.bind(this));\n        },\n        _hide: function(e)\n        {\n            var hidable = false;\n            var key = (e && e.which);\n\n            if (!e) hidable = true;\n            else if (e.type === 'click' || key === this.keycodes.ESC || key === this.keycodes.ENTER || key === this.keycodes.SPACE) hidable = true;\n\n            if (hidable)\n            {\n                this.$list.removeClass('open');\n                this.$list.hide();\n                this._reset();\n            }\n        },\n        _reset: function()\n        {\n            this.handleStr = '';\n            this.handleLen = this.handleStart;\n        },\n\t\t_replace: function(e)\n\t\t{\n    \t\te.preventDefault();\n\n    \t\tvar $item = $R.dom(e.target);\n    \t\tvar key = $item.attr('data-key');\n    \t\tvar replacement = this.data[key].replacement;\n\n    \t\tvar marker = this.marker.insert('start');\n    \t\tvar $marker = $R.dom(marker);\n            var current = marker.previousSibling;\n            var currentText = current.textContent;\n            var re = new RegExp('@' + this.handleStr + '$');\n\n        \tcurrentText = currentText.replace(re, '');\n        \tcurrent.textContent = currentText;\n\n            $marker.before(replacement);\n\n \t\t\tthis.selection.restoreMarkers();\n\n            return;\n\t\t}\n    });\n})(Redactor);"]}